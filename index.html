<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÂàÜÈîÄË¥¶Âçï 7.3 - Á¨¶Âè∑ÊóÖÊ∏∏</title>
  <style>
    :root {
      /* Ê†∏ÂøÉÈÖçËâ≤ */
      --primary: #002b49;       
      --primary-light: #f0f4f8; 
      --accent: #c5a065;        
      --text-main: #111827;
      --text-sub: #4b5563;
      --border: #e5e7eb;
      --white: #ffffff;
      --danger: #dc2626;
      --success: #10b981;
      --warning: #f59e0b;
      --info: #3b82f6;
      --font-stack: "Inter", "Helvetica Neue", Helvetica, Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
      --shadow-paper: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: var(--font-stack);
      background: #f3f4f6;
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    .app-container { display: flex; height: 100vh; width: 100vw; }

    /* Icons */
    svg { width: 14px; height: 14px; stroke: currentColor; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }

    /* Preview Area */
    .pane-preview { flex: 1; background: #e5e7eb; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
    .toolbar { padding: 12px 24px; background: var(--white); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
    .toolbar h1 { margin: 0; font-size: 16px; font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    .preview-scroll-area { flex: 1; overflow-y: auto; padding: 40px; display: flex; justify-content: center; background-image: radial-gradient(#9ca3af 1px, transparent 1px); background-size: 20px 20px; }
    .paper { width: 210mm; min-height: 297mm; background: white; box-shadow: var(--shadow-paper); padding: 40px; display: flex; flex-direction: column; position: relative; }

    /* Form Area */
    .pane-form { width: 640px; background: var(--white); display: flex; flex-direction: column; box-shadow: -5px 0 15px rgba(0,0,0,0.03); z-index: 20; }
    .form-header { padding: 16px 20px; border-bottom: 1px solid var(--border); }
    .form-header h2 { margin: 0; font-size: 18px; }
    .form-scroll-area { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 150px; }
    .form-group { background: var(--primary-light); border: 1px solid #dae2ed; border-radius: 8px; padding: 16px; margin-bottom: 16px; transition: all 0.3s; }
    .form-title { font-size: 12px; font-weight: 700; color: var(--primary); text-transform: uppercase; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .row { display: flex; gap: 10px; margin-bottom: 10px; }
    .col { flex: 1; min-width: 0; }
    .col-sm { flex: 0 0 80px; }
    label { display: block; font-size: 11px; color: var(--text-sub); margin-bottom: 4px; font-weight: 600; }
     
    /* --- Unified Input Group Style --- */
    .input-group { display: flex; width: 100%; align-items: stretch; position: relative; }
    .input-group .input-box { flex: 1; position: relative; }
    .input-group .input-box input { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; width: 100%; padding-right: 26px; }
    .input-group select { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; width: 100%; flex: 1; }

    /* The Button on the right (Grouped) */
    .group-btn {
      width: 38px; background-color: #f9fafb; border: 1px solid var(--border); border-left: 1px solid #e5e7eb;
      border-top-right-radius: 6px; border-bottom-right-radius: 6px;
      display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; color: #64748b;
    }
    .group-btn:hover { background-color: #e0f2fe; color: var(--primary); border-color: #d1d5db; }
    .group-btn svg { width: 15px; height: 15px; }

    /* Merged Group (Same style) */
    .merged-group { display: flex; width: 100%; align-items: stretch; }
    .merged-group .input-box { flex: 1; }
    .merged-group .input-box input { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; }
    .merged-trigger {
      width: 38px; background-color: #f9fafb; border: 1px solid var(--border); border-left: 1px solid #e5e7eb;
      border-top-right-radius: 6px; border-bottom-right-radius: 6px;
      display: flex; align-items: center; justify-content: center; cursor: pointer; color: #64748b;
      position: relative; overflow: hidden; 
    }
    .merged-trigger:hover { background-color: #eff6ff; color: var(--info); }

    /* Standard Inputs */
    input, textarea, select { width: 100%; font-family: inherit; font-size: 13px; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--white); }
    textarea { resize: vertical; min-height: 60px; }
    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); }
    input[readonly], textarea[readonly] { background-color: #e5e7eb; color: #6b7280; cursor: not-allowed; border-color: #d1d5db; }

    /* Clear X Button */
    .input-box { position: relative; }
    .input-box input[type="text"], .input-box textarea { padding-right: 26px; }
    .clear-x {
      position: absolute; right: 6px; top: 50%; transform: translateY(-50%);
      font-size: 12px; color: #9ca3af; cursor: pointer; display: none; z-index: 5;
      width: 16px; height: 16px; line-height: 15px; text-align: center; background: rgba(255,255,255,0.8); border-radius: 50%; font-weight: bold;
    }
    .clear-x:hover { color: #ef4444; background: #fee2e2; }
    .input-box.has-val .clear-x { display: block; }
    textarea + .clear-x { top: 12px; transform: none; }

    /* --- Date Picker Fix --- */
    .input-box.date-box input[type="text"] { padding-right: 26px; } 
     
    /* Independent Button Style (Price Save) */
    .btn-icon-separate {
      width: 36px; height: 35px; flex: 0 0 36px;
      background-color: #f9fafb; border: 1px solid var(--border); border-radius: 6px;
      display: flex; align-items: center; justify-content: center; cursor: pointer; color: #64748b;
    }
    .btn-icon-separate:hover { background-color: #e0f2fe; color: var(--primary); border-color: #d1d5db; }

    /* Hidden Date Input */
    .hidden-date-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }

    /* Buttons */
    .btn { border: none; border-radius: 4px; padding: 8px 16px; font-size: 13px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; font-weight: 600; font-family: inherit; }
    .btn svg { width: 14px; height: 14px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
    .btn-sm { padding: 4px 8px; font-size: 11px; }
    .btn-save { background: var(--success); color: white; border: 1px solid #059669; }
    .btn-del { background: #fee2e2; color: var(--danger); border: 1px solid #f87171; }
    .btn-edit { background: #eff6ff; color: var(--info); border: 1px solid #bfdbfe; }
    .btn-backup { background: var(--warning); color: white; margin-right: 4px; }
    .btn-restore { background: #9ca3af; color: white; }
    .btn-addon { background: #e0f2fe; color: var(--primary); border: 1px solid #bae6fd; font-size: 11px; padding: 3px 8px; }
    .btn-toggle { background: transparent; color: var(--primary); border: 1px solid var(--primary); }
    .btn-toggle:hover { background: var(--primary); color: white; }

    /* Icon Only Button (Plain) */
    .btn-icon { padding: 6px; border-radius: 4px; background: transparent; color: #64748b; border: 1px solid transparent; }
    .btn-icon:hover { background: #f3f4f6; color: var(--text-main); border-color: #e5e7eb; }

    #client-details-wrapper, #payment-wrapper { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #cbd5e1; }
    .status-msg { font-size: 10px; margin-top: 2px; height: 14px; display: block; }
    .status-saved { color: #059669; } .status-exist { color: #d97706; }

    .db-row { display: flex; gap: 0px; align-items: center; width: 100%; }
    .db-row .input-box { flex: 1; }
    .db-row .input-box input { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: 0; }
    .db-row button { border-top-left-radius: 0; border-bottom-left-radius: 0; border-left: 1px solid #bfdbfe; }

    .item-grid-top { display: grid; grid-template-columns: 1fr 1fr 1.1fr; gap: 6px; margin-bottom: 6px; }
    .item-grid-btm { display: grid; grid-template-columns: 0.8fr 1.5fr 1.1fr 1.1fr 0.9fr 1fr; gap: 6px; }

    .addon-row-wrap { margin-top: 6px; padding-left: 12px; border-left: 2px solid #bae6fd; }
    .addon-item { display: flex; gap: 6px; align-items: center; margin-bottom: 4px; background: #f0f9ff; padding: 4px; border-radius: 4px; width: 100%; }
    .addon-item .addon-desc-wrapper { flex: 1; min-width: 0; } 
    .addon-item .addon-num-wrapper { flex: 0 0 60px; } 
    .addon-item .addon-num-wrapper.wide { flex: 0 0 80px; } 
    .addon-item input { width: 100%; font-size: 11px; padding: 4px 6px; height: 28px; }
    .addon-item .input-box { width: 100%; }
    .addon-item input[type="number"] { padding-right: 4px; }
    .addon-item .clear-x { right: 24px; }

    /* --- Bill Style --- */
    .meta-val, .inv-box-content, .inv-table td, .info-text, .trade-name, .legal-name, .tax-id-line { text-transform: uppercase; }
    .inv-header { display: flex; justify-content: space-between; margin-bottom: 30px; border-bottom: 3px solid var(--primary); padding-bottom: 20px; align-items: flex-end; }
    .inv-logo-text { font-size: 26px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    .inv-addr { font-size: 12px; color: var(--text-sub); margin-top: 6px; line-height: 1.5; font-weight: 500; }
    .inv-right { text-align: right; }
    .inv-title { font-size: 36px; font-weight: 900; color: #e5e7eb; letter-spacing: 2px; line-height: 1; margin-bottom: 4px; }
    .inv-subtitle { font-size: 14px; color: var(--text-sub); letter-spacing: 2px; text-transform: uppercase; font-weight: 700; margin-bottom: 15px; }
    .meta-horizontal { display: flex; gap: 24px; justify-content: flex-end; align-items: flex-end; }
    .meta-group { text-align: right; }
    .meta-label { font-size: 11px; color: var(--text-sub); font-weight: 600; text-transform: uppercase; margin-bottom: 2px; }
    .meta-val { font-size: 14px; font-weight: 700; color: var(--text-main); }
    .box-container { display: flex; gap: 24px; margin-bottom: 30px; }
    .inv-box { flex: 1; border: 1px solid #e5e7eb; border-radius: 6px; padding: 16px; position: relative; background: #f9fafb; }
    .inv-box.left { border-left: 5px solid var(--primary); }
    .inv-box.right { border-left: 5px solid var(--accent); }
    .box-label { font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 10px; letter-spacing: 0.5px; }
    .box-label .en-sub { font-size: 10px; font-weight: 400; opacity: 0.8; margin-left: 4px; text-transform: uppercase; }
    .box-content { font-size: 12px; line-height: 1.6; color: var(--text-main); }
    .trade-name { font-size: 14px; font-weight: 800; color: var(--primary); margin-bottom: 4px; }
    .legal-name { font-size: 12px; color: var(--text-main); font-weight: 600; margin-bottom: 4px; }
    .legal-name.is-sub { font-size: 11px; color: var(--text-sub); font-weight: 400; }
    .tax-id-line { font-size: 11px; color: var(--text-main); margin-bottom: 6px; }
    .label-main { color: var(--text-sub); font-size: 11px; margin-right: 2px; font-weight: 600; }
    .label-sub { color: #9ca3af; font-size: 9px; margin-right: 6px; }

    .inv-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; table-layout: fixed; }
    .inv-table th { background: var(--primary); color: white; padding: 12px 4px; font-size: 11px; text-align: right; font-weight: 700; overflow:hidden; }
    .inv-table th:first-child { text-align: left; }
    .inv-table th .th-sub { display: block; font-size: 8px; opacity: 0.7; font-weight: 400; text-transform: uppercase; margin-top: 2px; white-space:nowrap; }
    .inv-table td { border-bottom: 1px solid #e5e7eb; padding: 10px 4px; font-size: 11px; vertical-align: top; line-height: 1.4; overflow-wrap: break-word; }
    .inv-table .num { text-align: right; font-feature-settings: "tnum"; font-weight: 500; }
    .inv-table tr:last-child td { border-bottom: 2px solid var(--primary); }
     
    /* ADDON STYLE (Italic + Gray) */
    .row-addon td { 
      border-bottom: 1px solid #f3f4f6; 
      background: #fcfcfc; 
      color: var(--text-sub);
      font-style: italic; 
    }
    .inv-table tr.row-addon td.addon-desc { padding-left: 55px; position: relative; }
    .inv-table tr.row-addon td.addon-desc::before { content: "‚Ü≥"; position: absolute; left: 12px; opacity: 0.5; font-family: sans-serif; font-style: normal; }
     
    .text-red { color: var(--danger); }
    .text-bold { font-weight: 700; color: #000; }
    .comm-detail { font-size: 9px; color: #9ca3af; margin-top: 2px; line-height: 1; }

    .inv-footer { display: flex; gap: 40px; margin-top: 10px; }
    .footer-left { flex: 1; }
    .footer-right { width: 320px; }
    .info-block { margin-bottom: 20px; border-left: 3px solid #e5e7eb; padding-left: 12px; }
    .info-title { font-size: 12px; font-weight: 700; color: var(--text-main); margin-bottom: 6px; }
    .info-title .en-sub { font-size: 10px; font-weight: 400; color: var(--text-sub); margin-left: 4px; text-transform: uppercase; }
    .info-text { font-size: 11px; line-height: 1.5; color: var(--text-main); white-space: pre-wrap; }

    .total-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 12px; color: var(--text-sub); }
    .total-label { font-weight: 600; color: var(--text-sub); }
    .total-label span { display: block; }
    .total-label .en { font-size: 10px; opacity: 0.7; font-weight: 400; margin-top: 1px; }
    .total-row.gross { border-top: 1px solid #e5e7eb; margin-top: 8px; padding-top: 10px; color: var(--text-main); }
    .total-row.gross .total-label { font-weight: 700; color: var(--text-main); font-size: 13px; }
    .total-row.comm { color: var(--danger); font-weight: 500; }
    .total-row.comm .total-label { color: var(--danger); }
    .net-box { background: var(--primary); color: white; padding: 14px 16px; border-radius: 6px; margin-top: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .net-title { font-size: 12px; font-weight: 700; text-transform: uppercase; }
    .net-title .en { display: block; font-size: 10px; opacity: 0.8; text-transform: uppercase; font-weight: 400; margin-top: 2px; }
    .net-val { font-size: 20px; font-weight: 800; letter-spacing: 0.5px; }

    /* Sync Indicator */
    .sync-indicator { font-size: 11px; font-weight: 600; margin-left: 10px; display: flex; align-items: center; gap: 4px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .dot.connected { background: #10b981; box-shadow: 0 0 5px #10b981; }
    .dot.connecting { background: #f59e0b; }
    .dot.offline { background: #ef4444; }

    @media print {
      @page { size: A4; margin: 0; }
      html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: white; }
      .pane-form, .toolbar { display: none !important; }
      .pane-preview { border: none; height: auto; display: block; background: white; position: relative; width: 100%; }
      .preview-scroll-area { padding: 0; margin: 0; background: white; overflow: visible; display: block; }
      .paper { width: 100% !important; max-width: none !important; height: auto !important; box-shadow: none !important; padding: 30px 40px !important; margin: 0 !important; transform: none !important; border: none !important; }
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body>

<div class="app-container">
  <div class="pane-preview">
    <div class="toolbar">
      <h1>ÂàÜÈîÄË¥¶Âçï V7.3 <div id="sync-status" class="sync-indicator"><span class="dot connecting"></span> <span id="sync-text">Connecting...</span></div></h1>
      <div>
        <button class="btn btn-backup" onclick="exportData()"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Â§á‰ªΩÊï∞ÊçÆ Backup</button>
        <button class="btn btn-restore" onclick="document.getElementById('importFile').click()"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg> ÊÅ¢Â§çÊï∞ÊçÆ Restore</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(this)" accept=".json">
        <span style="border-left:1px solid #d1d5db; margin:0 8px; height:16px; display:inline-block; vertical-align:middle;"></span>
        <button class="btn btn-outline" onclick="resetForm()"><svg viewBox="0 0 24 24"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg> ÈáçÁΩÆ Reset</button>
        <button class="btn btn-primary" onclick="printBill()"><svg viewBox="0 0 24 24"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg> ÊâìÂç∞ / PDF Print</button>
      </div>
    </div>
    <div class="preview-scroll-area">
      <div class="paper" id="invoice-paper">
        <div class="inv-header">
          <div style="flex:1">
            <div class="inv-logo-text"><span data-bind="agencyName">Á¨¶Âè∑ÊóÖÊ∏∏ FH GLOBAL, S.L.</span></div>
            <div class="inv-addr" data-bind="agencyAddress" data-format="multiline"></div>
            <div class="inv-addr" data-bind="agencyContact" data-format="multiline"></div>
          </div>
          <div class="inv-right">
            <div class="inv-title">Ë¥¶Âçï BILL</div>
            <div class="inv-subtitle"> </div>
            <div class="meta-horizontal">
              <div class="meta-group"><div class="meta-label">ÁºñÂè∑ Exp #</div><div class="meta-val" data-bind="invNo"></div></div>
              <div class="meta-group"><div class="meta-label">Êó•Êúü Date</div><div class="meta-val" id="pv-invDate-formatted"></div></div>
            </div>
          </div>
        </div>

        <div class="box-container">
          <div class="inv-box left">
            <div class="box-label">ÂÆ¢Êà∑‰ø°ÊÅØ <span class="en-sub">Bill To</span></div>
            <div class="box-content">
              <div class="trade-name" data-bind="billTradeName"></div>
              <div id="pv-billCompany" class="legal-name"></div>
              <div id="pv-billTaxId" class="tax-id-line"></div>
              <div style="margin-top:4px; white-space: pre-wrap;" data-bind="billAddress" data-format="multiline"></div>
            </div>
          </div>
          <div class="inv-box right">
            <div class="box-label">Ëà™Ê¨°‰ø°ÊÅØ <span class="en-sub">Cruise Details</span></div>
            <div class="box-content">
              <div style="margin-bottom:4px"><span class="label-main">ËàπÂêç</span><span class="label-sub">SHIP</span><strong data-bind="ship"></strong></div>
              <div style="margin-bottom:4px"><span class="label-main">Ëà™Á∫ø</span><span class="label-sub">ROUTE</span><span data-bind="route"></span></div>
              <div style="margin-bottom:4px"><span class="label-main">Ëà™Êúü</span><span class="label-sub">SAILING</span><span id="pv-sailing-combined"></span></div>
              </div>
          </div>
        </div>

        <table class="inv-table">
          <thead>
            <tr>
              <th style="width: 34%">Ëà±ÊàøËØ¥Êòé <span class="th-sub">Cabin Description</span></th>
              <th class="num" style="width: 8%">‰∫∫Êï∞/Êï∞Èáè <span class="th-sub">PAX</span></th>
              <th class="num" style="width: 10%">Áõ¥ÂÆ¢‰ª∑ <span class="th-sub">Gross Price</span></th>
              <th class="num" style="width: 9%">ÂáÄËàπÁ•® <span class="th-sub">Base Fare</span></th>
              <th class="num" style="width: 10%">‰Ω£Èáë <span class="th-sub">Commission</span></th>
              <th class="num" style="width: 9%">Á®éË¥π <span class="th-sub">Tax</span></th>
              <th class="num" style="width: 9%">ÊúçÂä°Ë¥π <span class="th-sub">HSC</span></th>
              <th class="num" style="width: 11%">ÁªìÁÆó‰ª∑ <span class="th-sub">Net Payable</span></th>
            </tr>
          </thead>
          <tbody id="preview-items-body"></tbody>
        </table>

        <div class="inv-footer">
          <div class="footer-left">
            <div class="info-block" style="border-left-color: var(--primary);">
              <div class="info-title">ÊîØ‰ªòÊñπÂºè <span class="en-sub">Payment Details</span></div>
              <div class="info-text" data-bind="payment" data-format="multiline"></div>
            </div>
            <div class="info-block" style="border-left-color: var(--accent);">
              <div class="info-title">Â§áÊ≥®Êù°Ê¨æ <span class="en-sub">Remarks</span></div>
              <div class="info-text" data-bind="remarks" data-format="multiline"></div>
            </div>
          </div>
          <div class="footer-right">
            <div class="total-row"><div class="total-label">Áõ¥ÂÆ¢ÊÄª‰ª∑<span class="en">Total Gross Price</span></div><div id="display-gross">0.00</div></div>
            <div class="total-row"><div class="total-label">Á®éË¥πÊúçÂä°Ë¥πÊÄªÈ¢ù<span class="en">Total Taxes & HSC</span></div><div id="display-total-tax-hsc">0.00</div></div>
            <div class="total-row"><div class="total-label">ÂáÄËàπÁ•®ÊÄª‰ª∑<span class="en">Total Base Fare</span></div><div id="display-total-base">0.00</div></div>
            <div class="total-row comm"><div class="total-label">Âáè: ‰Ω£Èáë<span class="en">Less Commission</span></div><div id="display-commission">- 0.00</div></div>
            <div class="net-box"><div class="net-title">ÂÆû‰ªòÁªìÁÆó‰ª∑ <span class="en">Net Payable (EUR)</span></div><div class="net-val" id="display-net">0.00</div></div>
          </div>
        </div>
        
        <div style="margin-top:auto; padding-top:20px; border-top:1px solid #eee; text-align:center; font-size:10px; color:#9ca3af;">
          FH GLOBAL S.L. with NIF: B72398340. Paseo Quince De Mayo 3, 28019 Madrid.
        </div>
      </div>
    </div>
  </div>

  <div class="pane-form">
    <div class="form-header"><h2>Ë¥¶ÂçïÂΩïÂÖ• Edit Bill</h2></div>
    <div class="form-scroll-area">
      <div class="form-group">
        <div class="form-title">Âü∫Á°Ä‰ø°ÊÅØ Basic Info</div>
        <div class="row"><div class="col"><label>ÁºñÂè∑ Exp No.</label><div class="input-box"><input type="text" id="invNo" placeholder="EXP-2024-001" oninput="checkClear(this)"><span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span></div></div><div class="col"><label>Êó•Êúü Date</label><div class="input-box"><input type="date" id="invDate" oninput="checkClear(this)"></div></div></div>
      </div>
      <div style="display:none">
        <input type="text" id="agencyName" value="Á¨¶Âè∑ÊóÖÊ∏∏ FH GLOBAL, S.L."><textarea id="agencyAddress">PASEO QUINCE DE MAYO 3, 28019 MADRID</textarea><textarea id="agencyContact">Tel: +34 919471812 | fhglobal@fhglobal.es</textarea><input type="text" id="currency" value="EUR">
      </div>

      <div class="form-group">
        <div class="form-title">ÂÆ¢Êà∑‰ø°ÊÅØ Client Info</div>
        <div class="input-group" style="margin-bottom: 10px;">
           <select id="clientSelect" onchange="selectClient()"><option value="">-- ÈÄâÊã©Â∏∏Áî®ÂÆ¢Êà∑ Select Client --</option></select>
           <div class="group-btn" onclick="toggleClientDetails()" title="ÁºñËæë/Êñ∞Â¢û"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></div>
        </div>
        
        <div id="client-details-wrapper">
          <div class="row">
            <div class="col"><label>ÂïÜÁî®ÂêçÁß∞ Trade Name</label><div class="input-box"><input type="text" id="billTradeName" placeholder="Ctrip / Êê∫Á®ã" oninput="checkClear(this)"><span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span></div></div>
            <div class="col-sm"><label>‰Ω£Èáë% Comm</label><div class="input-box"><input type="number" id="billDefaultRate" value="0"></div></div>
            <div class="col-sm"><label>ÈôÑÂä†‰Ω£Èáë% Addon</label><div class="input-box"><input type="number" id="billAddonRate" value="0"></div></div>
          </div>
          <div class="row"><div class="col"><label>ÂÖ¨Âè∏Ê≥®ÂÜåÂêçÁß∞ Legal Name</label><div class="input-box"><input type="text" id="billCompany" oninput="checkClear(this)"><span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span></div></div></div>
          <div class="row"><div class="col"><label>Á®éÂè∑ CIF / VAT No.</label><div class="input-box"><input type="text" id="billTaxId" placeholder="e.g. ES12345678" oninput="checkClear(this)"><span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span></div></div></div>
          <div class="row"><div class="col"><label>Âú∞ÂùÄ Address</label><div class="input-box"><textarea id="billAddress" oninput="checkClear(this)"></textarea><span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span></div></div></div>
          <div style="text-align:right; margin-top:10px;">
             <button class="btn btn-sm btn-outline" onclick="toggleClientDetails()">Êî∂Ëµ∑ Hide</button>
             <button class="btn btn-sm btn-save" onclick="saveClient()"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg> ‰øùÂ≠ò Save</button>
          </div>
        </div>
      </div>

      <div class="form-group">
        <div class="form-title">Ëà™Ê¨°‰ø°ÊÅØ Cruise Info</div>
        <div class="row">
            <div class="col"><label>ËàπÂêç Ship</label><div class="merged-group"><div class="input-box"><input type="text" id="ship" list="shipList" placeholder="" onblur="autoSaveShip(this)" oninput="checkClear(this)"><span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span></div><div class="merged-trigger" onclick="editShip()"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></div><datalist id="shipList"></datalist></div><span id="msg-ship" class="status-msg"></span></div>
            <div class="col"><label>Ëà™Á∫ø Route</label><div class="merged-group"><div class="input-box"><input type="text" id="route" list="routeList" placeholder="" onblur="autoSaveRoute(this)" oninput="checkClear(this)"><span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span></div><div class="merged-trigger" onclick="editRoute()"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></div><datalist id="routeList"></datalist></div><span id="msg-route" class="status-msg"></span></div>
        </div>
        <div class="row">
            <div class="col"><label>Âá∫Âèë Start</label><div class="merged-group"><div class="input-box"><input type="text" id="sailingStart" onblur="smartDateInput(this)" onkeypress="handleDateKey(event, this)" oninput="checkClear(this)"><span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span></div><div class="merged-trigger" onclick="openPicker('pickerStart')"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><input type="date" id="pickerStart" class="hidden-date-overlay" onchange="pickDate(this, 'sailingStart')"></div></div></div>
            <div class="col"><label>ÁªìÊùü End</label><div class="merged-group"><div class="input-box"><input type="text" id="sailingEnd" onblur="smartDateInput(this)" onkeypress="handleDateKey(event, this)" oninput="checkClear(this)"><span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span></div><div class="merged-trigger" onclick="openPicker('pickerEnd')"><svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><input type="date" id="pickerEnd" class="hidden-date-overlay" onchange="pickDate(this, 'sailingEnd')"></div></div></div>
            </div>
      </div>

      <div class="form-group" style="border-color:#fca5a5; background:#fff1f2;">
        <div class="form-title" style="color:#b91c1c;"><span>Ë¥πÁî®ÊòéÁªÜ Items</span><div><button class="btn btn-primary btn-sm" onclick="addItem()"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Ê∑ªÂä†Ëà±Êàø Add Cabin</button></div></div>
        <datalist id="dl-types"></datalist><datalist id="dl-exps"></datalist><datalist id="dl-prices"></datalist><datalist id="dl-addons"></datalist>
        <div id="items-container"></div>
      </div>

      <div class="form-group">
        <div class="form-title">
          <span>ÊîØ‰ªò‰∏éÂ§áÊ≥® Payment & Notes</span>
          <button class="btn btn-sm btn-toggle" onclick="togglePayment()"><svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg> Êü•Áúã/ÁºñËæë Show/Edit</button>
        </div>
        <div id="payment-wrapper">
          <div class="row"><div class="col"><label>ÊîØ‰ªò‰ø°ÊÅØ Payment</label><div class="input-box"><textarea id="payment" oninput="checkClear(this)"></textarea><span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span></div></div></div>
          <div class="row"><div class="col"><label>Â§áÊ≥® Remarks</label><div class="input-box"><textarea id="remarks" oninput="checkClear(this)"></textarea><span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span></div></div></div>
        </div>
      </div>
      <div style="height:30px"></div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCqPv-u0OJtysiCYSQjcdMb6zJHTrBA6bc",
    authDomain: "viajes-fh.firebaseapp.com",
    databaseURL: "https://viajes-fh-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "viajes-fh",
    storageBucket: "viajes-fh.firebasestorage.app",
    messagingSenderId: "572278294722",
    appId: "1:572278294722:web:09c67b95790dc47b52135b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // --- 1. JSON BACKUP DATA ---
  const BACKUP_DATA = {
    clients: [
      { tradeName: "ÁéØÁêÉ‰πãÊóÖ", company: "DYNASTY TICKETING Kft.", taxId: "26542003242", address: "Csepreghy utca 4. 2. em. 13. ajt√≥ Budapest, Budapest f≈ëv√°ros, 1085 Hungary", rate: 5, addonRate: 5 },
      { tradeName: "ËìùÂ§©ÊóÖË°åÁ§æ", company: "VIAJES ANDY, S.L.", taxId: "B86105301", address: "Avenida Oporto, 108, 28019 Madrid", rate: 15, addonRate: 0 },
      { tradeName: "ÈïøÂüéÊóÖË°åÁ§æ", company: "VIAJES GRAN MURALLA, S.L.", taxId: "B85644490", address: "Calle Nicolas Sanchez, 41, 28026 Madrid", rate: 15, addonRate: 0 },
      { tradeName: "‰∏≠Â§©ÊóÖË°åÁ§æ", company: "VIAJES DESPEJADO, S.L.", taxId: "B84988948", address: "Calle Nicolas Sanchez, 6, 28026 Madrid", rate: 15, addonRate: 0 },
      { tradeName: "ÁéØÁêÉÊóÖË°åÁ§æ", company: "GRAN ASIA TOUR, S.L.", taxId: "B84962927", address: "Calle Dolores Barranco, 49, 28026 Madrid", rate: 10, addonRate: 3 },
      { tradeName: "ÂáØË∂äÊóÖË°åÁ§æ", company: "FREEMAN TRAVEL CO, S.L.", taxId: "B56487168", address: "Calle de Gabino Jimeno, 15, 28026 Madrid", rate: 10, addonRate: 3 }
    ],
    ships: [
      "‚îÅ‚îÅ‚îÅ MSC CRUISES ‚îÅ‚îÅ‚îÅ", "MSC Ê¨ßÁΩóÂ∑¥Âè∑ MSC World Europa", "MSC ÁæéÊ¥≤Âè∑ MSC World America", "MSC Ê¨ßÁëûÊØî‰∫öÂè∑ MSC Euribia", "MSC ÂçéÂΩ©Âè∑ MSC Virtuosa", "MSC È∏øÂõæÂè∑ MSC Grandiosa", "MSC Ëç£ËÄÄÂè∑ MSC Bellissima", "MSC ‰º†Â•áÂè∑ MSC Meraviglia", "MSC Êµ∑Á•ûÂè∑ MSC Seascape", "MSC Êµ∑ÈôÖÂè∑ MSC Seashore", "MSC Êµ∑ÊôØÂè∑ MSC Seaview", "MSC Êµ∑Â≤∏Á∫øÂè∑ MSC Seaside", "MSC ÁèçÁà±Âè∑ MSC Preziosa", "MSC Á•ûÊõ≤Âè∑ MSC Divina", "MSC ËæâÁÖåÂè∑ MSC Splendida", "MSC ÂπªÊÉ≥Êõ≤Âè∑ MSC Fantasia", "MSC Âçé‰∏ΩÂè∑ MSC Magnifica", "MSC ËØóÊ≠åÂè∑ MSC Poesia", "MSC ÁÆ°‰πêÂè∑ MSC Orchestra", "MSC Èü≥‰πêÂè∑ MSC Musica", "MSC Ê≠åÂâßÂè∑ MSC Opera", "MSC ÊäíÊÉÖÂè∑ MSC Lirica", "MSC Â∫èÊõ≤Âè∑ MSC Sinfonia", "MSC ÂíåË∞êÂè∑ MSC Armonia",
      "‚îÅ‚îÅ‚îÅ COSTA CRUISES ‚îÅ‚îÅ‚îÅ", "Ê≠åËØóËææ¬∑ÊâòÊñØÂç°Á∫≥Âè∑ Costa Toscana", "Ê≠åËØóËææ¬∑Áø°Áø†Âè∑ Costa Smeralda", "Ê≠åËØóËææ¬∑ÁöáÂÜ†Âè∑ Costa Diadema", "Ê≠åËØóËææ¬∑Ëø∑‰∫∫Âè∑ Costa Fascinosa", "Ê≠åËØóËææ¬∑ÂîØÁæéÂè∑ Costa Favolosa", "Ê≠åËØóËææ¬∑ÁãÑÂà©Êë©Ëê®Âè∑ Costa Deliziosa", "Ê≠åËØóËææ¬∑Â§™Âπ≥Ê¥ãÂè∑ Costa Pacifica", "Ê≠åËØóËææ¬∑ËµõÁê≥Â®úÂè∑ Costa Serena", "Ê≠åËØóËææ¬∑Âπ∏ËøêÂè∑ Costa Fortuna"
    ],
    routes: [
      "Âú∞‰∏≠Êµ∑Ëà™Á∫ø (The Mediterranean)", "ÂåóÊ¨ßËà™Á∫ø (Northern Europe)", "Âä†ÂãíÊØîÊµ∑‰∏éÂåóÁæéËà™Á∫ø (Caribbean & North America)", "‰∏≠‰∏úËà™Á∫ø (Middle East)", "ÂçóÁæéËà™Á∫ø (South America)", "ÈïøËà™Á∫ø‰∏éÁéØÁêÉ (Grand Voyages & World Cruise)"
    ],
    dbTypes: ["Interior (ÂÜÖËà±)", "Oceanview (Êµ∑ÊôØ)", "Balcony (Èò≥Âè∞)"],
    dbExps: ["Bella (ÁæéÂ¶ôÁ∫ß)", "Fantastica (Ê¢¶Âπª)"],
    dbPrices: ["Basic (Âü∫Á°Ä)", "Special (Áâπ‰ª∑)"],
    dbAddons: ["Wifi Package (ÁΩëÁªúÂåÖ)", "Shore Excursion (Â≤∏‰∏äËßÇÂÖâ)", "Drink Package (ÈÖíÊ∞¥)", "Service Charge (ÊúçÂä°Ë¥π)", "Transfer (Êé•ÈÄÅ)"]
  };

  // Status Indicator
  const syncDot = document.querySelector('.dot');
  const syncText = document.getElementById('sync-text');

  function setStatus(status, text) {
      syncDot.className = 'dot ' + status;
      syncText.textContent = text;
  }

  // --- Data Variables ---
  window.items = []; window.clients = []; window.ships = []; window.routes = [];
  window.dbTypes = []; window.dbExps = []; window.dbPrices = []; window.dbAddons = [];
  
  const DEFAULT_PAYMENT = "Bank: CAIXABANK\nName: FH GLOBAL, S.L.\nSWIFT: CAIXESBBXXX\nAccount: ES4521003304042200150167";
  const DEFAULT_REMARKS = "ËØ∑Âú®Ë¥¶ÂçïÁîüÊàêÂêé24‰∏™Â∞èÊó∂ÂÜÖ‰ªòÊ¨æ„ÄÇ\nPlease settle the payment within 24 hours";
  const defaultItem = { name: "", ref: "", type: "", exp: "", price: "", qty: "", base: "", tax: "", hsc: "", rate: "", extra: "", addons: [] };

  // --- Helpers ---
  window.formatMoney = (amount) => new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount || 0);

  window.checkClear = function(input) {
      const box = input.closest('.input-box');
      if (input.value && input.value.trim() !== '') box.classList.add('has-val');
      else box.classList.remove('has-val');
      if(input.id !== 'ship' && input.id !== 'route') window.updateState();
  }
  
  window.clearField = function(span) {
      const box = span.closest('.input-box');
      const input = box.querySelector('input, textarea');
      input.value = '';
      box.classList.remove('has-val');
      input.focus();
      const evt = new Event('input', { bubbles: true });
      input.dispatchEvent(evt);
      if(input.id === 'ship') window.autoSaveShip(input);
      if(input.id === 'route') window.autoSaveRoute(input);
      if(input.id === 'sailingStart' || input.id === 'sailingEnd') window.updateState();
  }

  window.toggleClientDetails = function() {
    const wrapper = document.getElementById('client-details-wrapper');
    wrapper.style.display = (wrapper.style.display === 'none' || wrapper.style.display === '') ? 'block' : 'none';
  }

  window.togglePayment = function() {
    const wrapper = document.getElementById('payment-wrapper');
    wrapper.style.display = (wrapper.style.display === 'none' || wrapper.style.display === '') ? 'block' : 'none';
  }

  window.openPicker = function(pickerId) { try { document.getElementById(pickerId).showPicker(); } catch(e) { document.getElementById(pickerId).focus(); } }
  window.pickDate = function(picker, textId) {
    const val = picker.value; 
    if(val) {
        const [y, m, d] = val.split('-');
        const textInput = document.getElementById(textId);
        textInput.value = `${d}/${m}/${y}`;
        window.updateState();
        window.checkClear(textInput);
    }
  }

  // --- DB Operations ---
  window.editShip = function() { editDatabaseItem('ship', window.ships, 'settings/ships', 'shipList'); }
  window.editRoute = function() { editDatabaseItem('route', window.routes, 'settings/routes', 'routeList'); }
  
  function editDatabaseItem(inputId, dbArray, dbPath, listId) {
      const input = document.getElementById(inputId);
      const oldVal = input.value;
      if (!oldVal) return;
      const idx = dbArray.findIndex(item => item.toLowerCase() === oldVal.toLowerCase());
      if (idx === -1) { alert("Êú™ÊâæÂà∞ËØ•È°π (Entry not found in DB)"); return; }
      const newVal = prompt("ÁºñËæëÂêçÁß∞ Edit Name:", dbArray[idx]);
      if (newVal && newVal.trim() !== "" && newVal !== dbArray[idx]) {
          dbArray[idx] = newVal.trim();
          set(ref(db, dbPath), dbArray); 
          input.value = newVal.trim();
          const msgId = inputId === 'ship' ? 'msg-ship' : 'msg-route';
          const msgEl = document.getElementById(msgId);
          if(msgEl) { msgEl.textContent = "‚úÖ Â∑≤Êõ¥Êñ∞ Updated"; msgEl.className = "status-msg status-saved"; }
          window.updateState();
      }
  }

  window.autoSaveShip = function(input) { handleAutoSave(input, window.ships, 'settings/ships', 'shipList', 'msg-ship'); }
  window.autoSaveRoute = function(input) { handleAutoSave(input, window.routes, 'settings/routes', 'routeList', 'msg-route'); }
  
  function handleAutoSave(input, dbArray, dbPath, listId, msgId) {
      const val = input.value.trim();
      const msgEl = document.getElementById(msgId);
      if (!val) { msgEl.textContent = ''; return; }
      const exists = dbArray.some(item => item.toLowerCase() === val.toLowerCase());
      if (exists) {
          msgEl.textContent = "‚úÖ Â∑≤Â≠òÂú® Existing"; msgEl.className = "status-msg status-exist";
      } else {
          dbArray.push(val); 
          set(ref(db, dbPath), dbArray); 
          msgEl.textContent = "üíæ Â∑≤‰øùÂ≠ò Saved"; msgEl.className = "status-msg status-saved";
      }
      window.updateState();
  }

  window.handleSmartKey = function(e, input) { if(e.key === 'Enter') input.blur(); }
  window.smartComplete = function(input, db, index, key) {
    const val = input.value.trim().toLowerCase(); if(!val) { window.updateItem(index, key, ""); return; }
    const match = db.find(item => { const lower = item.toLowerCase(); return lower.startsWith(val) || lower.includes(" " + val) || lower.includes("(" + val); });
    if(match) { input.value = match; window.updateItem(index, key, match); } else window.updateItem(index, key, input.value);
    window.checkClear(input);
  }
  
  window.autoSaveItemDB = function(input, dbArray, dbPath, listId) {
    const val = input.value.trim();
    if(!val) return;
    const exists = dbArray.some(item => item.toLowerCase() === val.toLowerCase());
    if(!exists) {
        dbArray.push(val);
        set(ref(db, dbPath), dbArray);
    }
  }

  window.editItemDb = function(index, field, dbArray, dbPath, listId) {
      const oldVal = window.items[index][field];
      if(!oldVal) return;
      const dbIdx = dbArray.findIndex(item => item.toLowerCase() === oldVal.toLowerCase());
      const newVal = prompt("ÁºñËæë/‰øÆÊîπ Edit " + field + ":", oldVal);
      if(newVal && newVal.trim() !== "") {
          if(dbIdx !== -1) {
              dbArray[dbIdx] = newVal.trim();
              set(ref(db, dbPath), dbArray);
          }
          window.items[index][field] = newVal.trim();
          window.renderItemInputs(); 
          window.updateState();
      }
  }
  
  window.editAddonDb = function(itemIndex, addonIndex, dbArray, dbPath, listId) {
      const oldVal = window.items[itemIndex].addons[addonIndex].desc;
      if(!oldVal) return;
      const dbIdx = dbArray.findIndex(item => item.toLowerCase() === oldVal.toLowerCase());
      const newVal = prompt("ÁºñËæë/‰øÆÊîπ Edit Add-on Name:", oldVal);
      if(newVal && newVal.trim() !== "") {
          if(dbIdx !== -1) {
              dbArray[dbIdx] = newVal.trim();
              set(ref(db, dbPath), dbArray);
          }
          window.items[itemIndex].addons[addonIndex].desc = newVal.trim();
          window.renderItemInputs(); 
          window.updateState();
      }
  }

  window.smartCompleteAddon = function(input, rowIndex, addonIndex) {
    const val = input.value.trim().toLowerCase(); const dbList = window.dbAddons;
    if(!val) { window.items[rowIndex].addons[addonIndex].desc = ""; window.updateState(); return; }
    const match = dbList.find(item => { const lower = item.toLowerCase(); return lower.startsWith(val) || lower.includes(" " + val) || lower.includes("(" + val); });
    if(match) input.value = match; window.items[rowIndex].addons[addonIndex].desc = input.value; window.updateState();
    window.checkClear(input);
  }

  window.handleDateKey = function(e, input) { if(e.key === 'Enter') input.blur(); }
  window.smartDateInput = function(input) {
    const val = input.value.trim(); if(!val) { window.updateState(); return; }
    const now = new Date(); let d, m, y;
    const parts = val.replace(/[.-]/g, '/').split('/');
    if(parts.length === 1) { d=parseInt(parts[0]); m=now.getMonth()+1; y=now.getFullYear(); }
    else if(parts.length === 2) { d=parseInt(parts[0]); m=parseInt(parts[1]); y=now.getFullYear(); }
    else if(parts.length === 3) { d=parseInt(parts[0]); m=parseInt(parts[1]); y=parseInt(parts[2]); if(y<100) y+=2000; }
    else return;
    if(isNaN(d)||isNaN(m)||isNaN(y)) return;
    input.value = `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`;
    window.checkClear(input);
    window.updateState();
  }
  window.parseDateStr = function(str) { if(!str) return null; const parts = str.split('/'); if(parts.length !== 3) return null; return new Date(parts[2], parts[1]-1, parts[0]); }

  window.printBill = function() {
      const invNo = document.getElementById('invNo').value.trim();
      const oldTitle = document.title;
      if (invNo) { document.title = `ÈÇÆËΩÆË¥¶Âçï ${invNo}`; } else { document.title = `ÈÇÆËΩÆË¥¶Âçï`; }
      window.print();
      setTimeout(() => { document.title = oldTitle; }, 500);
  }

  window.exportData = function() {
    const saveData = { 
        clients: window.clients, ships: window.ships, routes: window.routes, 
        dbTypes: window.dbTypes, dbExps: window.dbExps, dbPrices: window.dbPrices, dbAddons: window.dbAddons, 
        currentBill: { items: window.items, fields: getFieldsData() } 
    };
    const blob = new Blob([JSON.stringify(saveData,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=`FH_Global_CloudBackup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
  }
  
  window.importData = function(input) {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader(); reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);
        if(confirm("ÊÅ¢Â§çÊï∞ÊçÆÂ∞ÜË¶ÜÁõñ‰∫ëÁ´ØÊï∞ÊçÆÔºåÊòØÂê¶ÁªßÁª≠Ôºü\nRestore will overwrite Cloud Data. Continue?")) {
            if(data.clients) set(ref(db, 'settings/clients'), data.clients);
            if(data.ships) set(ref(db, 'settings/ships'), data.ships);
            if(data.routes) set(ref(db, 'settings/routes'), data.routes);
            if(data.dbTypes) set(ref(db, 'settings/types'), data.dbTypes);
            if(data.dbExps) set(ref(db, 'settings/exps'), data.dbExps);
            if(data.dbPrices) set(ref(db, 'settings/prices'), data.dbPrices);
            if(data.dbAddons) set(ref(db, 'settings/addons'), data.dbAddons);
            if(data.currentBill) set(ref(db, 'draft'), data.currentBill);
            alert("‚úÖ ÊÅ¢Â§çÊàêÂäü Restored to Cloud!");
        }
      } catch(err) { alert("‚ùå ÈîôËØØ Error"); }
    }; reader.readAsText(file); input.value='';
  }

  // --- Rendering ---
  function renderAllDatalists() {
    renderDatalist('shipList', window.ships); renderDatalist('routeList', window.routes);
    renderDatalist('dl-types', window.dbTypes); renderDatalist('dl-exps', window.dbExps); 
    renderDatalist('dl-prices', window.dbPrices); renderDatalist('dl-addons', window.dbAddons);
  }
  function renderDatalist(id, arr) { 
      const dl = document.getElementById(id); dl.innerHTML=''; 
      (arr||[]).forEach(val => { const opt=document.createElement('option'); opt.value=val; dl.appendChild(opt); }); 
  }

  function renderClientSelect() {
    const sel=document.getElementById('clientSelect'); sel.innerHTML='<option value="">-- ÈÄâÊã©Â∏∏Áî®ÂÆ¢Êà∑ Select Client --</option>';
    (window.clients||[]).forEach((c,i)=>{ const label=c.tradeName?`${c.tradeName} (${c.company})`:c.company; const opt=document.createElement('option'); opt.value=i; opt.text=label; sel.appendChild(opt); });
  }
  window.saveClient = function() {
    const company=document.getElementById('billCompany').value.trim(); if(!company) return alert("Missing Company Name");
    const newClient={ tradeName:document.getElementById('billTradeName').value, company, address:document.getElementById('billAddress').value, rate:document.getElementById('billDefaultRate').value||0, addonRate:document.getElementById('billAddonRate').value||0, taxId:document.getElementById('billTaxId').value || '' };
    const idx=window.clients.findIndex(c=>c.company===company); 
    let newClientsArr = [...window.clients];
    if(idx>=0){ if(confirm("Êõ¥Êñ∞ÂÆ¢Êà∑‰ø°ÊÅØÔºü Update?")) newClientsArr[idx]=newClient; else return; } else newClientsArr.push(newClient);
    set(ref(db, 'settings/clients'), newClientsArr); 
    alert("Â∑≤‰øùÂ≠ò Saved!");
  }
  window.selectClient = function() {
    const idx=document.getElementById('clientSelect').value; if(idx==="") return;
    const c=window.clients[idx]; 
    document.getElementById('billTradeName').value=c.tradeName||''; document.getElementById('billCompany').value=c.company; document.getElementById('billAddress').value=c.address; document.getElementById('billDefaultRate').value=c.rate||0; document.getElementById('billAddonRate').value=c.addonRate||0; document.getElementById('billTaxId').value=c.taxId||'';
    ['billTradeName','billCompany','billAddress','billDefaultRate','billTaxId','billAddonRate'].forEach(id => window.checkClear(document.getElementById(id)));
    const newRate=Number(c.rate)||0; const newAddonRate=Number(c.addonRate)||0;
    if(window.items.length>0){ window.items.forEach(i=> { i.rate=newRate; if(i.addons) i.addons.forEach(a=>a.rate=newAddonRate); }); window.renderItemInputs(); }
    defaultItem.rate=newRate; window.updateState();
  }

  window.renderItemInputs = function() {
    const container = document.getElementById('items-container'); container.innerHTML = '';
    window.items.forEach((item, index) => {
      let addonsHtml = '';
      if(item.addons && item.addons.length > 0) {
          item.addons.forEach((ad, aIdx) => {
              addonsHtml += `
                <div class="addon-item">
                   <span style="font-size:10px; color:#0ea5e9;">‚Ü≥</span>
                   <div class="addon-desc-wrapper">
                      <div class="merged-group">
                        <div class="input-box">
                            <input type="text" list="dl-addons" placeholder="ÈôÑÂä†‰∫ßÂìÅÂêçÁß∞ Add-on Name" value="${ad.desc}" onblur="smartCompleteAddon(this, ${index}, ${aIdx}); autoSaveItemDB(this, window.dbAddons, 'settings/addons', 'dl-addons')" onkeypress="handleSmartKey(event, this)" oninput="checkClear(this)">
                            <span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span>
                        </div>
                        <div class="merged-trigger" onclick="editAddonDb(${index}, ${aIdx}, window.dbAddons, 'settings/addons', 'dl-addons')"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></div>
                      </div>
                   </div>
                   <div class="addon-num-wrapper"><input type="number" placeholder="Êï∞Èáè Qty" value="${ad.qty}" oninput="updateAddon(${index}, ${aIdx}, 'qty', this.value)"></div>
                   <div class="addon-num-wrapper wide"><input type="number" placeholder="Âçï‰ª∑ Unit" value="${ad.amount}" oninput="updateAddon(${index}, ${aIdx}, 'amount', this.value)"></div>
                   <div class="addon-num-wrapper"><input type="number" placeholder="‰Ω£Èáë% Comm" value="${ad.rate}" oninput="updateAddon(${index}, ${aIdx}, 'rate', this.value)" title="Comm %"></div>
                   <div class="addon-col-del"><span style="color:#ef4444; cursor:pointer; font-size:12px;" onclick="removeAddon(${index}, ${aIdx})"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span></div>
                </div>`;
          });
      }
      const div = document.createElement('div');
      div.style.cssText = "background:white; border:1px solid #e5e7eb; border-radius:4px; padding:10px; margin-bottom:10px;";
      div.innerHTML = `
        <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
           <span style="font-weight:700; color:#b91c1c; font-size:11px;">#${index + 1}</span>
           <div>
              <button class="btn btn-icon" onclick="copyItem(${index})"><svg viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button><button class="btn btn-icon" style="color:#dc2626" onclick="deleteItem(${index})"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:6px;">
           <div class="input-box" style="flex:1">
             <input type="text" placeholder="ÊóÖÂÆ¢ÂßìÂêç Passenger Name" value="${item.name||''}" oninput="updateItem(${index}, 'name', this.value);checkClear(this)" style="font-weight:bold;">
             <span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span>
           </div>
           <div class="input-box" style="flex:1">
             <input type="text" placeholder="È¢ÑËÆ¢Âè∑ Ref No." value="${item.ref||''}" oninput="updateItem(${index}, 'ref', this.value);checkClear(this)">
             <span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span>
           </div>
        </div>
        <div class="item-grid-top">
           <div class="merged-group">
              <div class="input-box"><input type="text" list="dl-types" placeholder="Ëà±ÊàøÁ±ªÂûã" value="${item.type||''}" onblur="smartComplete(this, window.dbTypes, ${index}, 'type'); autoSaveItemDB(this, window.dbTypes, 'settings/types', 'dl-types')" onkeypress="handleSmartKey(event, this)" oninput="checkClear(this)"><span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span></div>
              <div class="merged-trigger" onclick="editItemDb(${index}, 'type', window.dbTypes, 'settings/types', 'dl-types')"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></div>
           </div>
           <div class="merged-group">
              <div class="input-box"><input type="text" list="dl-exps" placeholder="‰ΩìÈ™åÁ±ªÂûã" value="${item.exp||''}" onblur="smartComplete(this, window.dbExps, ${index}, 'exp'); autoSaveItemDB(this, window.dbExps, 'settings/exps', 'dl-exps')" onkeypress="handleSmartKey(event, this)" oninput="checkClear(this)"><span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span></div>
              <div class="merged-trigger" onclick="editItemDb(${index}, 'exp', window.dbExps, 'settings/exps', 'dl-exps')"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></div>
           </div>
           <div class="merged-group">
              <div class="input-box"><input type="text" list="dl-prices" placeholder="‰ª∑Ê†ºÁ±ªÂûã" value="${item.price||''}" onblur="smartComplete(this, window.dbPrices, ${index}, 'price'); autoSaveItemDB(this, window.dbPrices, 'settings/prices', 'dl-prices')" onkeypress="handleSmartKey(event, this)" oninput="checkClear(this)"><span class="clear-x" onclick="clearField(this)"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span></div>
              <div class="merged-trigger" onclick="editItemDb(${index}, 'price', window.dbPrices, 'settings/prices', 'dl-prices')"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></div>
           </div>
        </div>
        <div class="item-grid-btm">
           <div><label>‰∫∫Êï∞ PAX</label><div class="input-box"><input type="number" value="${item.qty}" oninput="updateItem(${index}, 'qty', this.value)"></div></div>
           <div><label>Áõ¥ÂÆ¢‰ª∑ Gross</label><div class="input-box"><input type="number" value="${item.base}" oninput="updateItem(${index}, 'base', this.value)"></div></div>
           <div><label>Á®éË¥π Tax</label><div class="input-box"><input type="number" value="${item.tax}" oninput="updateItem(${index}, 'tax', this.value)"></div></div>
           <div><label>ÊúçÂä°Ë¥π HSC</label><div class="input-box"><input type="number" value="${item.hsc}" oninput="updateItem(${index}, 'hsc', this.value)"></div></div>
           <div><label>‰Ω£Èáë% Rate</label><div class="input-box"><input type="number" value="${item.rate}" oninput="updateItem(${index}, 'rate', this.value)" placeholder="ÊØî‰æã"></div></div>
           <div><label>È¢ùÂ§ñ Extra</label><div class="input-box"><input type="number" value="${item.extra}" oninput="updateItem(${index}, 'extra', this.value)" placeholder="ÈáëÈ¢ù"></div></div>
        </div>
        <div class="addon-row-wrap">${addonsHtml}<button class="btn btn-addon" onclick="addAddon(${index})">‚ûï ÈôÑÂä†‰∫ßÂìÅ Add-on</button></div>
      `;
      container.appendChild(div);
      div.querySelectorAll('.input-box input, .input-box textarea').forEach(inp => window.checkClear(inp));
    });
  }

  window.updateItem = function(index, key, val) { window.items[index][key] = val; window.updateState(); }
  window.addAddon = function(idx) { const rate = document.getElementById('billAddonRate').value || 0; if(!window.items[idx].addons) window.items[idx].addons = []; window.items[idx].addons.push({ desc: "", amount: 0, rate: rate, qty: 1 }); window.renderItemInputs(); window.updateState(); }
  window.removeAddon = function(idx, aIdx) { window.items[idx].addons.splice(aIdx, 1); window.renderItemInputs(); window.updateState(); }
  window.updateAddon = function(idx, aIdx, key, val) { window.items[idx].addons[aIdx][key] = val; window.updateState(); }
  window.addItem = function() { const rate = document.getElementById('billDefaultRate').value || 0; window.items.push({ ...defaultItem, rate, addons: [] }); window.renderItemInputs(); window.updateState(); }
  window.deleteItem = function(i) { if(confirm('ÊòØÂê¶Âà†Èô§ Delete?')) { window.items.splice(i, 1); window.renderItemInputs(); window.updateState(); } }
  window.copyItem = function(i) { window.items.splice(i+1, 0, JSON.parse(JSON.stringify(window.items[i]))); window.renderItemInputs(); window.updateState(); }

  window.updateState = function() {
    document.querySelectorAll('[id]').forEach(el => {
      if(el.closest('.pane-form') && !el.closest('#items-container') && !['clientSelect','sailingStart','sailingEnd'].includes(el.id)) {
        const target = document.querySelector(`[data-bind="${el.id}"]`);
        if(el.id === 'billCompany') {
             const tradeNameVal = document.getElementById('billTradeName').value;
             const elPv = document.getElementById('pv-billCompany');
             if(elPv) { elPv.textContent = el.value; if(tradeNameVal && tradeNameVal.trim() !== '') elPv.classList.add('is-sub'); else elPv.classList.remove('is-sub'); }
        } else if(el.id === 'billTaxId') {
             const elPv = document.getElementById('pv-billTaxId');
             if(elPv) elPv.textContent = el.value ? `CIF/VAT: ${el.value}` : '';
        } else if(el.id === 'invDate') {
             const val = el.value; if(val) { const [y, m, d] = val.split('-'); document.getElementById('pv-invDate-formatted').textContent = `${d}/${m}/${y}`; }
        } else if (target) {
          if (target.dataset.format === 'multiline') target.innerHTML = (el.value || '').replace(/\n/g, '<br>');
          else target.textContent = el.value;
        }
      }
    });

    // --- Updated Duration Calculation Logic ---
    const sStart = document.getElementById('sailingStart').value;
    const sEnd = document.getElementById('sailingEnd').value;
    const start = window.parseDateStr(sStart), end = window.parseDateStr(sEnd);
    if(start&&end&&!isNaN(start)&&!isNaN(end)) {
      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
      const nights = diffDays;      // e.g. 8th - 1st = 7 nights
      const days = diffDays + 1;    // e.g. 7 nights = 8 days
      document.getElementById('pv-sailing-combined').textContent = `${sStart} ~ ${sEnd} (${days}Â§© ${nights}Êôö)`;
    } else {
      document.getElementById('pv-sailing-combined').textContent = [sStart, sEnd].filter(Boolean).join(' ~ ');
    }

    const tbody = document.getElementById('preview-items-body');
    tbody.innerHTML = '';
    let tBase=0, tTax=0, tHSC=0, tComm=0, totalGrossPrice = 0;

    window.items.forEach(item => {
      const qty = Number(item.qty)||0;
      const grossPrice = Number(item.base)||0; 
      const tax = Number(item.tax)||0;
      const hsc = Number(item.hsc)||0;
      const rate = Number(item.rate)||0;
      const extra = Number(item.extra)||0; 
      
      const commBase = grossPrice - tax - hsc - extra;
      const comm = (commBase * (rate/100)) + extra;
      const net = grossPrice - comm; 
      
      tBase += commBase; tTax += tax; tHSC += hsc; tComm += comm; totalGrossPrice += grossPrice;

      const cabinDesc = [item.type, item.exp, item.price].filter(Boolean).join(' / ');
      const descParts = [item.name, item.ref, cabinDesc].filter(Boolean);
      const fullNameDesc = descParts.join(' - ');
      
      let addonsRows = '';
      if(item.addons && item.addons.length > 0) {
          item.addons.forEach(ad => {
              const aQty = Number(ad.qty) || 1;
              const unit = Number(ad.amount)||0;
              const adGross = aQty * unit; 
              const r = Number(ad.rate)||0;
              const adComm = adGross * (r/100);
              const adNet = adGross - adComm;
              
              tBase += adGross; totalGrossPrice += adGross; tComm += adComm;
              
              addonsRows += `
                <tr class="row-addon">
                    <td class="addon-desc"><div>${ad.desc || 'ÈôÑÂä†‰∫ßÂìÅ'}</div></td>
                    <td class="num">${aQty}</td>
                    <td class="num">${window.formatMoney(adGross)}</td>
                    <td class="num">-</td>
                    <td class="num text-red"><div>- ${window.formatMoney(adComm)}</div></td>
                    <td class="num">-</td>
                    <td class="num">-</td>
                    <td class="num text-bold">${window.formatMoney(adNet)}</td>
                </tr>`;
          });
      }

      let commHtml = `<div class="text-red">- ${window.formatMoney(comm)}</div>`;
      if (rate > 0 || extra > 0) {
          let detailStr = `(${rate}%`; if(extra > 0) detailStr += ` + ${extra}`; detailStr += `)`;
          commHtml += `<div class="comm-detail">${detailStr}</div>`;
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><div style="font-weight:600; color:#1f2937">${fullNameDesc || '-'}</div></td>
        <td class="num">${qty}</td>
        <td class="num">${window.formatMoney(grossPrice)}</td>
        <td class="num">${window.formatMoney(commBase)}</td>
        <td class="num">${commHtml}</td>
        <td class="num">${window.formatMoney(tax)}</td>
        <td class="num">${window.formatMoney(hsc)}</td>
        <td class="num text-bold">${window.formatMoney(net)}</td>
      `;
      tbody.appendChild(tr);
      if(addonsRows) tbody.insertAdjacentHTML('beforeend', addonsRows);
    });

    if(window.items.length===0) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#ccc;padding:20px;">ÊöÇÊó†È°πÁõÆ No Items / Êó†ÊòéÁªÜ</td></tr>';

    const gross = totalGrossPrice; 
    const net = gross - tComm; 
    
    document.getElementById('display-total-base').textContent = window.formatMoney(tBase);
    document.getElementById('display-total-tax-hsc').textContent = window.formatMoney(tTax + tHSC);
    document.getElementById('display-gross').textContent = 'EUR ' + window.formatMoney(gross); 
    document.getElementById('display-commission').textContent = '- EUR ' + window.formatMoney(tComm);
    document.getElementById('display-net').textContent = window.formatMoney(net);
    
    saveDraftDebounced();
  }

  function getFieldsData() {
    const data = {};
    document.querySelectorAll('.pane-form input:not([type=file]), .pane-form textarea').forEach(el => {
      if(el.id && !el.closest('#items-container') && !el.list && el.id!=='clientSelect') data[el.id] = el.value;
    });
    data['ship'] = document.getElementById('ship').value;
    data['route'] = document.getElementById('route').value;
    data['sailingStart'] = document.getElementById('sailingStart').value;
    data['sailingEnd'] = document.getElementById('sailingEnd').value;
    return data;
  }

  let saveTimeout;
  function saveDraftDebounced() {
      if(!auth.currentUser) return;
      setStatus('connecting', 'Saving...');
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
          const draftData = { items: window.items, fields: getFieldsData(), _updated: Date.now() };
          set(ref(db, 'draft'), draftData).then(() => {
              setStatus('connected', 'Synced');
          }).catch(err => {
              setStatus('offline', 'Error');
          });
      }, 500); 
  }

  // --- Database Initialization & Sync ---
  function initializeDatabase() {
      // Check if Settings exist, if not, upload BACKUP_DATA (Auto-Seed)
      get(ref(db, 'settings')).then((snapshot) => {
          if (!snapshot.exists()) {
             console.log("Empty DB detected. Uploading Backup Data...");
             set(ref(db, 'settings'), {
                 clients: BACKUP_DATA.clients,
                 ships: BACKUP_DATA.ships,
                 routes: BACKUP_DATA.routes,
                 types: BACKUP_DATA.dbTypes,
                 exps: BACKUP_DATA.dbExps,
                 prices: BACKUP_DATA.dbPrices,
                 addons: BACKUP_DATA.dbAddons
             });
          }
      });
  }

  function initListeners() {
      const settingsMap = [
          { key: 'clients', var: 'clients', default: BACKUP_DATA.clients },
          { key: 'ships', var: 'ships', default: BACKUP_DATA.ships },
          { key: 'routes', var: 'routes', default: BACKUP_DATA.routes },
          { key: 'types', var: 'dbTypes', default: BACKUP_DATA.dbTypes },
          { key: 'exps', var: 'dbExps', default: BACKUP_DATA.dbExps },
          { key: 'prices', var: 'dbPrices', default: BACKUP_DATA.dbPrices },
          { key: 'addons', var: 'dbAddons', default: BACKUP_DATA.dbAddons }
      ];

      settingsMap.forEach(setting => {
          onValue(ref(db, `settings/${setting.key}`), (snapshot) => {
              const val = snapshot.val();
              window[setting.var] = val || setting.default;
              if(setting.key === 'clients') renderClientSelect();
              else renderAllDatalists();
          });
      });

      onValue(ref(db, 'draft'), (snapshot) => {
          const data = snapshot.val();
          if(data) {
              if(data.fields) {
                  Object.entries(data.fields).forEach(([k,v]) => { 
                      const el=document.getElementById(k); 
                      if(el && document.activeElement !== el) { 
                          el.value=v; 
                          window.checkClear(el);
                      }
                  });
              }
              if(JSON.stringify(window.items) !== JSON.stringify(data.items || [])) {
                 window.items = (data.items || []).map(i => ({ ...defaultItem, ...i, addons: i.addons || [] }));
                 if(window.items.length === 0) window.items = [{ ...defaultItem, addons:[] }];
                 window.renderItemInputs();
              }
              window.updateState();
              setStatus('connected', 'Synced');
          } else {
              // --- New Draft: Auto-fill Date to Today ---
              document.getElementById('invDate').value = new Date().toISOString().split('T')[0];
              document.getElementById('payment').value = DEFAULT_PAYMENT;
              document.getElementById('remarks').value = DEFAULT_REMARKS;
              window.items = [{ ...defaultItem, addons:[] }];
              window.renderItemInputs();
              window.updateState();
          }
      });
  }

  window.resetForm = function() { 
    if(confirm("‚ö† Ë≠¶ÂëäÔºöËøôÂ∞ÜÊ∏ÖÁ©∫‰∫ëÁ´ØÂΩìÂâçË¥¶ÂçïÔºÅ\nWarning: This will clear the Cloud Draft.")) { 
        set(ref(db, 'draft'), null); 
        document.getElementById('invDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('payment').value = DEFAULT_PAYMENT;
        document.getElementById('remarks').value = DEFAULT_REMARKS;
        document.getElementById('invNo').value = "";
        document.getElementById('clientSelect').value = "";
        document.getElementById('billTradeName').value = "";
        document.getElementById('billCompany').value = "";
        document.getElementById('billTaxId').value = "";
        document.getElementById('billAddress').value = "";
        document.getElementById('billDefaultRate').value = 0;
        document.getElementById('billAddonRate').value = 0;
        document.getElementById('ship').value = "";
        document.getElementById('route').value = "";
        document.getElementById('sailingStart').value = "";
        document.getElementById('sailingEnd').value = "";
        // Removed global Ref reset
        window.items = [{ ...defaultItem, addons:[] }];
        window.renderItemInputs(); 
        window.updateState();
    } 
  }

  onAuthStateChanged(auth, (user) => {
      if (user) {
          setStatus('connected', 'Online');
          initializeDatabase(); 
          initListeners();
          
          document.querySelectorAll('.pane-form input, .pane-form textarea').forEach(el => {
            if(!el.closest('#items-container') && el.id!=='sailingStart' && el.id!=='sailingEnd') {
                el.addEventListener('input', window.updateState);
            }
          });
      } else {
          setStatus('offline', 'Offline');
      }
  });

  signInAnonymously(auth).catch((error) => {
      console.error(error);
      setStatus('offline', 'Auth Failed');
  });

</script>
</body>
</html>
